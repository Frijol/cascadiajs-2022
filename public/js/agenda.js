/* eslint-disable */

const agenda = [
  {
    "id": "day-one-open",
    "talk": false,
    "what": "Day One Open",
    "when": "2022-08-06T00:37:00.000Z"
  },
  {
    "id": "chris-coyier",
    "talk": true,
    "what": "Speaker Chris Coyier",
    "when": "2022-08-06T00:38:00.000Z"
  },
  {
    "id": "isabela-moreira",
    "talk": true,
    "what": "Speaker Isabela Moreira",
    "when": "2022-08-06T00:39:00.000Z"
  },
  {
    "id": "day-one-morning-break",
    "talk": false,
    "what": "Morning Break",
    "when": "2022-08-07T00:40:00.000Z"
  },
  {
    "id": "recKrDVtO7sMRVjuE",
    "talk": true,
    "what": "Speaker Leonardo Faria",
    "when": "2021-11-03T17:45:25.000Z"
  },
  {
    "id": "recFnVDImZdO7uPSW",
    "talk": true,
    "what": "Speaker Andrew Hao",
    "when": "2021-11-03T18:08:08.000Z"
  },
  {
    "id": "recUjGPhiQ7AYP0fY",
    "talk": true,
    "what": "Speaker Aaron Turner",
    "when": "2021-11-03T18:35:53.000Z"
  },
  {
    "id": "recprVw5cAWeefQ4n",
    "talk": false,
    "what": "Lunch break",
    "when": "2021-11-03T19:10:09.000Z"
  },
  {
    "id": "rec63Kwet9PhSPM5z",
    "talk": true,
    "what": "Speaker Ceora Ford",
    "when": "2021-11-03T20:45:00.000Z"
  },
  {
    "id": "recpdDsCWycvY11CV",
    "talk": true,
    "what": "Speaker Michelle Bakels",
    "when": "2021-11-03T21:10:35.000Z"
  },
  {
    "id": "recQaKG1vewBFT5ou",
    "talk": true,
    "what": "Speaker Romello Goodman",
    "when": "2021-11-03T21:38:46.000Z"
  },
  {
    "id": "recZND7UFTIOtoP8G",
    "talk": false,
    "what": "Coffee Break",
    "when": "2021-11-03T22:04:09.000Z"
  },
  {
    "id": "recB3SXFDcqNlVmRu",
    "talk": true,
    "what": "Speaker Josh Goldberg",
    "when": "2021-11-03T22:40:25.000Z"
  },
  {
    "id": "reckWcTAcddY5lxrL",
    "talk": true,
    "what": "Speaker Kyle Shevlin",
    "when": "2021-11-03T23:06:44.000Z"
  },
  {
    "id": "rechLlCSCpuf9uLI7",
    "talk": false,
    "what": "Cascadia Cup Finale",
    "when": "2021-11-03T23:34:33.000Z"
  },
  {
    "id": "recL1vvmw2eH2TMxI",
    "talk": false,
    "what": "Day One Close",
    "when": "2021-11-03T23:49:33.000Z"
  },
  {
    "id": "recCWikQliaDwx3uM",
    "talk": false,
    "what": "JavaScript Trivia Night",
    "when": "2021-11-03T23:54:33.000Z"
  },
  {
    "id": "rec1ndZfRUAIg6bth",
    "talk": false,
    "what": "Day Two Open",
    "when": "2021-11-04T16:10:20.000Z"
  },
  {
    "id": "recNZHckQN7Scg6lA",
    "talk": true,
    "what": "Speaker Charlie Gerard",
    "when": "2021-11-04T16:18:35.000Z"
  },
  {
    "id": "recRhUfh6f4vsGvff",
    "talk": true,
    "what": "Speaker Lizzie Siegle",
    "when": "2021-11-04T16:43:36.000Z"
  },
  {
    "id": "recYpPOqXBLoiGesD",
    "talk": false,
    "what": "Coffee Break",
    "when": "2021-11-04T17:09:07.000Z"
  },
  {
    "id": "rec8k4oQh3rAvJISd",
    "talk": true,
    "what": "Speaker Brooklyn Zelenka",
    "when": "2021-11-04T17:45:25.000Z"
  },
  {
    "id": "recg3dXTISGGReT54",
    "talk": true,
    "what": "Speaker Ian Sutherland",
    "when": "2021-11-04T18:12:30.000Z"
  },
  {
    "id": "rec6PwMcOvkBMj9vp",
    "talk": true,
    "what": "Speaker Jacques Favreau",
    "when": "2021-11-04T18:35:35.000Z"
  },
  {
    "id": "recsiGmpEkpK1UeLS",
    "talk": false,
    "what": "Lunch break",
    "when": "2021-11-04T19:08:47.000Z"
  },
  {
    "id": "recobGccJpfxXhXcB",
    "talk": true,
    "what": "Speaker Daria Caraway",
    "when": "2021-11-04T21:00:25.000Z"
  },
  {
    "id": "recdPYvemb8z9rfgX",
    "talk": true,
    "what": "Speaker Derek Hurley",
    "when": "2021-11-04T21:27:55.000Z"
  },
  {
    "id": "recRjBugpfpdEsOtC",
    "talk": false,
    "what": "Coffee Break",
    "when": "2021-11-04T22:02:26.000Z"
  },
  {
    "id": "recz3W6z9dVYMBgds",
    "talk": true,
    "what": "Speaker Garann Means",
    "when": "2021-11-04T22:45:25.000Z"
  },
  {
    "id": "recmoQZWUObP4q4FU",
    "talk": true,
    "what": "Speaker Feross",
    "when": "2021-11-04T23:13:15.000Z"
  },
  {
    "id": "recAf1h8tW7JyNMif",
    "talk": false,
    "what": "Day Two Close",
    "when": "2021-11-04T23:44:40.000Z"
  },
  {
    "id": "rec65BeJbaMM8OMo3",
    "talk": false,
    "what": "Live Music Performance",
    "when": "2021-11-05T00:00:00.000Z"
  }
]

document.addEventListener(
  "DOMContentLoaded",

  async function main() {
  
    // Check to see if there's a new agenda item happening so we can reset UIs
    function checkForNewAgendaItem() {
      console.log('Checking for new agenda item...')
      if (state.agenda !== undefined) {
        // find our current place in the agenda
        let currentAgendaIndex;
        let now = Date.now();
        for (let i in state.agenda) {
          let item = state.agenda[i];
          let itemTime = new Date(item.when).getTime();
          // if this item is after the current time
          if (now > itemTime) {
            currentAgendaIndex = parseInt(i)
          }
        }
        // the agenda is sorted by item.when asc, so if multiple items are after now(), the last / most recent will be set to the currentAgendaIndex

        if (currentAgendaIndex === undefined) {
          console.log("Waiting for agenda to begin... ", state.agenda[0])
        }
        else if (state.currentAgendaIndex !== currentAgendaIndex) {
          // a new agenda item!
          let current = state.agenda[currentAgendaIndex];
          console.log("A new agenda item!", current);
          let nextAgendaIndex = currentAgendaIndex + 1
          let next = nextAgendaIndex < state.agenda.length ? state.agenda[nextAgendaIndex] : undefined
          // reset the emote counter
          document
            .querySelector("emote-widget")
            .setAttribute("talk-id", current.id);
          // reset current/next UI
          document
            .getElementById("current-agenda")
            .innerHTML = current.what
          document
            .getElementById("next-agenda")
            .innerHTML = next ? next.what : ''      
          // reset index
          state.currentAgendaIndex = currentAgendaIndex;
        }
        else {
          // we are in the middle of an agenda item
        }
      }

      if (
        state.currentAgendaIndex === undefined ||
        state.currentAgendaIndex !== "????" // the last agenda item
      ) {
        // if the show hasn't started yet OR isn't over yet, keep checking for a new agenda item
        setTimeout(() => {
          checkForNewAgendaItem();
        }, 1000 * 20 /* re-run once every 20 seconds */);
      } else {
        console.log(
          "No more agenda items, the show must be over! Thanks for attending CascadiaJS :)"
        );
      }
    }

    // set initial state
    const state = {
      agenda: undefined,
      currentAgendaIndex: undefined,
    }

    // load agenda
    state.agenda = agenda // defined statically in this file, but maybe move to DB?
    state.agenda.sort((a, b) => new Date(a.when) - new Date(b.when));
    console.log(state.agenda)

    checkForNewAgendaItem();
  },
  false
);
